<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">

{{ partial "header.html" . }}

<body class="bg-light">

{{ partial "head.html" . }}

  <div class="container">
      <div id="accordion">
          <div class="card">
              <div class="card-header" id="headingOne">
                  <h5 class="mb-0">
                      <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                          Create new finished product
                      </button>
                  </h5>
              </div>

              <div id="collapseOne" class="collapse hide" aria-labelledby="headingOne" data-parent="#accordion">
                  <div class="card-body">
                      <div class="row">
                          <div class="col-md-3">
                              <div class="form-group"> <label for="inputmailh" class="">Product type<br></label>
                                  <select class="form-control custom-select" id="itemType">
                                      <option selected="">Choose one</option>
                                  </select>
                              </div>
                          </div>
                          <div class="col-md-1">
                              <div class="form-group"> <label for="inputpasswordh" class="">Count<br></label>
                                  <input type="number" class="form-control" id="count">
                              </div>
                          </div>
                      </div>
                      <div class="row pb-4">
                          <div class="col-md-12"><button id="add" class="btn btn-secondary">Add to list</button></div>
                      </div>
                      <div class="row">
                          <div class="col-md-12">
                              <table id="items" class="table table-striped table-bordered">
                                  <thead>
                                  <tr>
                                      <th>Name</th>
                                      <th>Count</th>
                                  </tr>
                                  </thead>
                              </table>
                          </div>
                      </div>
                      <hr />
                      <div class="row">
                          <div class="col-md-3">
                              <div class="form-group">
                                  <label for="inputpasswordh" class="">Finished product name<br>
                                  </label>
                                  <input type="text" class="form-control" id="finishedProductName">
                              </div>
                          </div>
                      </div>
                      <div class="row pb-4">
                          <div class="col-md-12"><button id="createNew" class="btn btn-secondary">Save new finished product</button></div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <div class="container">
      <div class="row pt-3">
          <div class="col-md-12">
              <table id="finishedProducts" class="table table-striped table-bordered">
                  <thead>
                  <tr>
                      <th>Name</th>
                      <th>Count</th>
                  </tr>
                  </thead>
              </table>
          </div>
      </div>
  </div>

{{ partial "footer.html" . }}

  <script>
    $(document).ready(function() {
        var fpTable = $("#finishedProducts").DataTable({
            ajax: "http://127.0.0.1:8080/outbound/config",
            columns: [{"data": "name"}, {"data": "count", "searchable": false}]
        });

      var items = $('#items').DataTable({
        "columns": [{ "data": "name" }, { "data": "count" }]
      });

      var reloadItemNameList = function() {
          $.ajax({
              type: "GET",
              url: '/inbound/config',
              accept: "application/json",
              success: function (data) {
                  let items = data.data;
                  if (items) {
                      $("#itemType").empty();
                      items.map(function (item) {
                          $("#itemType").append(new Option(item.type));
                      })
                  }
              },
              error: function (resp) {
                  console.log(resp.statusText)
              }
          });
      };

      reloadItemNameList();

      $("#createNew").on('click', function () {
          var tableData = items.rows().data();
          var fpName = $("#finishedProductName").val();
          if (tableData && fpName) {
              var cs = {};
              tableData.each(function (i) {
                  cs[i.name] = Number.parseInt(i.count)
              });
              var payload = {
                  name: fpName,
                  items: cs
              };
              $.ajax({
                  type: "POST",
                  url: '/outbound/config',
                  data: JSON.stringify(payload),
                  contentType: "application/json",
                  success: function() {
                      items.clear().draw();
                      fpTable.ajax.reload();
                      $("#finishedProductName").val('');
                      reloadItemNameList()
                  },
                  error: function(resp) {
                      console.log(resp.statusText)
                  }
              });
          }
      });

      $("#add").on('click', function() {
        let selectedItemName = $("#itemType option:selected");
        var name = selectedItemName.text();
        let itemCount = $("#count");
        var count = itemCount.val();
        if (name && count) {
          items.row.add({
            "name": name,
            "count": count
          }).draw();
          selectedItemName.remove();
          itemCount.val('')
        }
      })
    });
  </script>
</body>

</html>